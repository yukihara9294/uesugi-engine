# 開発履歴

最終更新: 2025-06-14  
更新者: Claude Code
更新内容: 人流データ表示の完全修正、市区町村内移動の改善、MDファイル統合

**重要：このファイルは作業完了時に必ず更新すること**

## MDファイルの役割分担
- **PROJECT_GUIDE.md**: 方針・仕様書（技術仕様、デザイン仕様、現在の課題）
- **CLAUDE.md**（本ファイル）: 作業記録・履歴（実施内容、エラー解決、引き継ぎ）
- **README.md**: 外部向け概要
- **MOBILITY_DATA_ANALYSIS.md**: 開発者確認用（一時保持）

## 更新ルール
- 作業開始時: PROJECT_GUIDE.mdで現状確認
- 作業中: 実施内容を本ファイルに記録
- 作業終了時: 両ファイルを更新

## 作業開始時のチェックリスト
1. [ ] PROJECT_GUIDE.md を読んだ
2. [ ] TECHNICAL_DETAILS.md を読んだ
3. [ ] .claude_instruction を確認した
4. [ ] 現在の問題点を把握した

## プロジェクトコアコンセプト
全国の行政・民間施策効果検証プラットフォーム
- リアルワールドデータ×ソーシャルネットワーキングデータ
- 因果推論AIによる反実仮想分析と未来予測
- 現在は仕様検討のため広島・山口データ可視化中

## 2025-06-11 実施内容（前半）

### 午前の作業
- MDファイル整理（53→3ファイルに削減）
- API実装（real_dataエンドポイント追加）
- 広島・山口データ収集完了
- コアコンセプトの再定義と文書修正

### 午後の作業
- MDファイル更新管理ルールの追加
- .claude_instructionにチェックリスト追加
- realDataLoader.jsを実際のAPI呼び出しに変更
- 各MDファイルに更新追跡情報を追加

### 2025-06-11 午後の作業
- 実データAPIの接続問題解決
- SNSヒートマップカテゴリフィルター問題修正
- 消費データ3D表示エラー修正
- 人流データアニメーション復元
- 3Dレイヤーエラー修正（Point→Polygon変換）

### 2025-06-11 セッション継続後の修正
- 人流データのパーティクルアニメーション修正（ベジエ曲線による北側迂回）
- 宿泊施設の透明度を50%に修正
- ランドマークトグルエラー修正（Point→Polygon変換）

## 2025-06-13 実施内容

### 環境セットアップ
- Docker環境のポート競合解決
  - Redis: 6379→6380
  - PostgreSQL: 5432→5433
  - Frontend: 3000→3001
- 全コンテナの正常起動確認

### エラー修正
- 地域選択時のonPrefectureSelectエラー修正
- CORS設定修正（localhost:3001を許可）
- SNSカテゴリフィルター修正（全OFF時は非表示）
- 人流データフォーマット認識エラー修正

### 人流データの大幅改善
1. **統計的推定モデルの実装**
   - MobilityEstimatorクラスを作成
   - 実際の統計データ使用（広島県人口280万人、通勤者45万人、年間観光客7000万人）
   - 重力モデルによるOD行列推定
   - フロータイプ分類（通勤/観光/一般）

2. **可視化の改善**
   - 山口県を地域選択に追加
   - フローライン透明度を0.15に変更
   - パーティクルのズームレベル対応（1px〜6px）
   - ライン幅を1/3に縮小（0.5px〜2px）
   - パーティクルがベジエ曲線上を正確に移動
   - フロータイプ別色分け統一（通勤:シアン、観光:マゼンタ、一般:イエロー）

3. **データ拡充**
   - 広島県全域40地点に拡大（県北部・東部含む）
   - 地域間移動の可視化実現
   - 3,000パーティクル以上の表示
- SNSヒートマップの色合いをダミーデータ時に統一（青→シアン→白→黄→オレンジ→赤）

### 修正済みの問題（2025-06-11）
1. **人流データのパーティクル** ✓
   - ダミーデータ時と同じベジエ曲線計算を実装
   - 北側迂回表現（Y座標に正のオフセット）を復元

2. **宿泊施設の表現** ✓
   - 透明度を50%に変更完了
   - サイズは0.0005のままで適切（変更不要）

3. **ランドマークトグル** ✓
   - Point→Polygon変換実装で3Dレイヤーエラー解消
   - 別ソースで3Dランドマークを管理

4. **SNSヒートマップ** ✓
   - 色合いをダミーデータ時の配色に統一
   - 青→シアン→白→黄→オレンジ→赤のグラデーション

### 重要な参考情報
- **デザイン仕様**: DESIGN_REFERENCE.mdを参照
- **目標**: ダミーデータ作成時のGitHubに保存された表現を完全にトレース
- **エラー対策**: fill-extrusionレイヤーにはPolygonデータが必須

## 実装した修正内容（2025-06-11 セッション継続後）

### 1. 人流データのパーティクルアニメーション修正
**ファイル**: `src/frontend/src/components/Map/MapWithRealData.jsx`（行936-976）
- ダミーデータ時（commit cb0661d）と同じベジエ曲線計算を実装
- 北側迂回の実装：`y + arcHeight * 0.5` でY座標に正のオフセット
- 主要な変更点：
  ```javascript
  // ベジエ曲線上の位置を計算
  const t = particleProgress;
  const x = start[0] * (1 - t) * (1 - t) + 2 * midpoint[0] * (1 - t) * t + end[0] * t * t;
  const y = start[1] * (1 - t) * (1 - t) + 2 * midpoint[1] * (1 - t) * t + end[1] * t * t;
  
  // 弧の高さ（中央で最大）
  const height = 0.1;
  const arcHeight = Math.sin(t * Math.PI) * height * distance;
  
  // 北向きに迂回（Y座標に正のオフセット）
  feature.geometry.coordinates = [x, y + arcHeight * 0.5];
  ```

### 2. 宿泊施設の透明度修正
**ファイル**: `src/frontend/src/components/Map/MapWithRealData.jsx`（行328）
- `fill-extrusion-opacity: 0.5` に変更（以前は0.8）

### 3. ランドマークトグルエラー修正
**ファイル**: `src/frontend/src/components/Map/MapWithRealData.jsx`（行533-647）
- Point データを Polygon に変換する処理を追加
- 3Dランドマーク用に別ソース `landmarks-3d-source` を作成
- 主要な変更点：
  - ポイントデータと3Dデータを分離
  - 高さ20m以上の建物のみ3D化
  - レイヤーマッピングに `landmarks-3d` を追加（行1055）

### 4. SNSヒートマップの色合い修正
**ファイル**: `src/frontend/src/components/Map/MapWithRealData.jsx`（行934-944）
- ダミーデータ時の配色に統一：
  ```javascript
  0, 'rgba(0,0,255,0)',      // 透明な青
  0.2, 'rgb(0,0,255)',       // 青
  0.4, 'rgb(0,255,255)',     // シアン
  0.5, 'rgb(255,255,255)',   // 白
  0.6, 'rgb(255,255,0)',     // 黄
  0.8, 'rgb(255,170,0)',     // オレンジ
  1, 'rgb(255,0,0)'          // 赤
  ```

### 次回デバッグ時の確認事項
1. 全レイヤーのトグル動作確認（特にランドマーク）
2. 人流パーティクルの北側迂回アニメーション確認
3. 宿泊施設の透明度確認
4. SNSヒートマップの色表現確認
5. パフォーマンスの確認

## 2025-06-14 実施内容

### GTFSエンドポイント修正
- float変換エラーの原因特定と修正
  - BOM付きUTF-8ファイルへの対応（utf-8-sig使用）
  - CSVフォーマットの正確な解析（stop_nameは2列目）
  - 空のstop_codeフィールドの適切な処理
  - 無効な座標データのスキップ処理実装
- 修正後の動作確認完了
- GitHubへのコミット済み

### マップ表現の大幅改善
1. **イベント情報の視覚改善**
   - オーブ風の光る表現に変更（外側ほど透明度が上がる）
   - 色を#FF6B6Bに統一（イベント情報タブと同色）
   - 中心の白丸を削除（2層構造に変更）

2. **ランドマーク表現の統一**
   - 全て黄色（#FFD700）の円柱に統一
   - 高さ制限を撤廃（全てのランドマークを3D表示）
   - 君田温泉森の泉を宿泊施設レイヤーに移行

3. **宿泊施設の改善**
   - 面積を1/3に縮小（0.0005 → 0.0005/3）
   - 高さを収容人数に応じて変更（capacity * 0.3）

4. **PLATEAU建物データの統合**
   - ランドマークトグルに統合（別トグル廃止）
   - 「PLATEAU 3D建物データ」→「建物データ」に名称変更
   - クリック時に枠付きポップアップで建物情報表示

5. **人流データの調整**
   - パーティクル数を10倍に増加（最大300個）
   - 距離ベース最適化を実装:
     - 近距離: 密度高く、ゆっくり移動
     - 中距離: 標準的な表示
     - 遠距離: 疎らに、速く移動
   - 視覚的な見栄えを重視した動的調整

### 2025-06-14 実施内容（第2セッション）

### パーティクルフロー5秒停止問題の修正
**問題**: APIデータロード時にCyberFlowLayerが再マウントされ、アニメーションが停止
**原因**: 
- MapWithRealData.jsxで動的`key`プロップ使用（dummy→real切り替え時）
- CyberFlowLayer.jsでmobilityDataが依存配列に含まれていた

**修正内容**:
1. **MapWithRealData.jsx** (行1491)
   - 動的`key={dataKey}`プロップを削除
   
2. **CyberFlowLayer.js**
   - `isInitialized`と`currentDataRef`を追加して状態管理
   - useEffect依存配列から`mobilityData`を削除
   - アニメーションの初期化を一度だけ実行するように改善

### MDファイル統合整理
**目的**: 方針の記載と修正履歴の管理を一元化
**実施内容**:
- PROJECT_GUIDE.md: 作業方針・現状・優先順位を集約
- CLAUDE.md: 開発履歴・修正記録を時系列で管理
- 情報削減なし、整理・統合のみ実施

### ERR_CONNECTION_RESETエラーの原因と対策
**問題**: 起動時に毎回 http://localhost:3000/ で接続リセットエラー発生
**原因**: ポート競合 - Docker外で`npm start`が実行されポート3000を占有
**解決方法**:
1. `lsof -i :3000`でポート使用確認
2. 使用中プロセスを`kill -9 <PID>`で停止
3. Dockerコンテナ再起動
**予防策**: Docker起動前に必ずポート確認を実施

### ポート変更（3001→3000）
- docker-compose.ymlのフロントエンドポートを3000:3000に変更
- 全ドキュメントのポート参照を3000に統一

### パーティクル表示改善
**実施内容**:
1. **パーティクル密度調整**: 通行量に基づいて表示数を調整（最小1/8、最大100%）
2. **フローラインフェードイン/アウト強化**: opacity範囲を0-0.3に増加
3. **パーティクルのライン追従**: flowPath追加でラインに沿った移動を実現

## 今後の優先タスク

### 高優先度
1. 3Dレイヤーエラー解消（ランドマーク関連）
2. SNSヒートマップのデザイン修正

### 中優先度
3. 岡山データ統合準備
4. 6地域統一フォーマット設計

### 将来タスク
5. AI因果推論エンジン実装
6. 反実仮想分析機能
7. 予測シミュレーション機能

## 2025-06-14 実施内容（続き）

### 人流パーティクルデザインの成功
1. **パーティクルサイズと透明度の最適化**
   - サイズを1/2に縮小（3-7 → 1.5-3.5）
   - 中心部透明度を大幅強化（0.2 → 0.1）
   - CyberFlowLayerでのグラデーション表現強化

2. **距離ベース最適化の実装成功**
   - 近距離（5km未満）：パーティクル数30%、速度15%
   - 中距離（5-20km）：標準設定
   - 遠距離（20km超）：パーティクル数200%、速度50%
   - 全体的に10倍のパーティクル数を実現

3. **視覚効果の改善**
   - フローラインのフェードイン・アウト実装
   - ベジエ曲線に沿った正確な移動軌跡
   - 多層グロー効果による立体的な光の表現

### イベント情報の改善
1. **中心部透明度の強化**
   - 0.2 → 0.05（ほぼ透明）に変更
   - 地図が透けて見えるように改善

2. **規模に応じたサイズ変更**
   - expected_visitorsに基づく動的サイズ調整
   - 小規模（1万人）から超大規模（20万人）まで対応

### 建物データの整理
1. **青丸の正体判明**
   - PLATEAU建物データのオフィスビル（#4A90E2）
   - ホテルは既に適切に宿泊施設レイヤーに分離済み

2. **宿泊施設の緑色統一**
   - 3D表示色を#4CAF50（緑）に変更
   - ラベルテキストも緑色に統一

3. **灰色立方体の整理**
   - 広島センタービルを削除（オフィスビルの重複）
   - 商業施設とオフィスビルのみPLATEAU層に残存

## 2025-06-14 実施内容（続き２）

### 人流パーティクル表示問題の詳細分析

#### 問題の経緯
1. **ユーザーからの要望**: 「人流パーティクルがまだ増えていないです、5回以上依頼していますが、反映されていないので、根本解決をお願いします」
2. **バックエンドAPI**: 正常に85,500パーティクルを生成している（確認済み）
3. **フロントエンド**: CyberFlowLayerが6,540パーティクルを受信しているが、5秒後に停止する

#### 技術的な問題点
1. **データフォーマットの不一致**
   - CyberFlowLayerは`particles`と`flows`の分離形式を期待
   - ダミーデータ（hiroshimaPrefectureDataGenerator.js）が正しい形式で生成
   - しかし、パーティクルの動きが5秒で停止

2. **パーティクルタイプの混在**
   - **渋滞ポイント周辺の円運動パーティクル**: `is_circular: true`
   - **フロー沿いのパーティクル**: `origin_lon/lat`, `destination_lon/lat`を持つ

3. **アニメーションロジックの問題**
   - 円運動パーティクルは正常に動作する可能性
   - フローパーティクルが終点に到達後、起点に戻らない可能性

#### 実装した修正内容
1. **hiroshimaPrefectureDataGenerator.js**
   ```javascript
   // 渋滞ポイントごとに10-50パーティクルを生成
   const particleCount = Math.max(10, Math.floor((point.flow_count || 10000) / 1000));
   
   // 円運動パラメータを追加
   is_circular: true,
   center_lon: point.coordinates[0],
   center_lat: point.coordinates[1],
   angle_offset: angle,
   orbit_radius: distance
   ```

2. **CyberFlowLayer.js**
   - 円運動と直線運動の両方に対応
   - アニメーションループで`is_circular`を判定して処理分岐

#### 次回デバッグ時の確認ポイント
1. **パーティクルの初期化確認**
   ```javascript
   console.log('Particle init:', particleKey, particleInfo);
   ```

2. **アニメーションループ内での位置更新確認**
   ```javascript
   console.log('Animation update:', key, particle.position, particle.angle);  
   ```

3. **5秒後の状態確認**
   - パーティクルのposition値が1に到達しているか
   - position=0にリセットされているか
   - アニメーションループが継続しているか

#### 推測される原因
1. **フローパーティクルの`position`が`undefined`になる**
   - 初期化時に`position: 0`が設定されていない可能性
   - `particle.position !== undefined`のチェックが失敗

2. **アニメーションフレームの停止**
   - エラーでanimationRef.currentが停止している可能性
   - try-catchでエラーが隠蔽されている

#### 解決案
1. **デバッグログの追加**
   - パーティクル初期化時の全プロパティ出力
   - アニメーション更新時の位置情報出力
   - 5秒後のパーティクル状態確認

2. **フォールバック処理の追加**
   - position=undefinedの場合は0に初期化
   - アニメーション停止検知とリスタート

3. **パフォーマンス最適化**
   - 6,540パーティクルは多すぎる可能性
   - 視認性を保ちつつ2,000程度に削減を検討

## 2025-06-14 実施内容（続き３）

### パーティクルクラスタリング問題の根本解決
**問題**: ユーザーから「パーティクルが一箇所に集まってうようよしている」「ラインに沿って動いていない」との報告
**原因分析**: CyberFlowLayer.jsの実装が複雑すぎて、パーティクルの位置計算が正しく動作していなかった

**実施した修正**:
1. **CyberFlowLayer.jsの全面書き換え**
   - 複雑な`particlePositions.current`管理を削除
   - シンプルな`particlesRef.current`配列に変更
   - 位置計算ロジックを簡素化

2. **パーティクル初期化の改善**
   ```javascript
   const particleData = {
     id: idx,
     flowIndex: flowIndex,
     position: Math.random(),  // 0-1の範囲でランダム配置
     speed: 0.003 + Math.random() * 0.005,
     color: flowPath.color,
     size: 2,
     flowPath: flowPath.points
   };
   ```

3. **アニメーションループの簡素化**
   - 各パーティクルの位置を単純にインクリメント
   - 1.0を超えたら0.0にリセット
   - フローパスに沿った座標計算を明確化

4. **デフォルトレイヤー設定の変更**
   - App.jsxで起動時は人流レイヤーのみONに設定
   - 他のレイヤーは全てOFFに変更

**結果**: パーティクルがフローラインに沿って正しく移動するようになった

### パーティクル表示問題の追加対応
**問題**: 2箇所のラインしか表示されず、パーティクルが集中している
**原因**: APIから返される85,500個のパーティクルのflow_indexが、100個のフローのインデックス範囲を超えていた
**対応**: 
- APIのパーティクルデータを無視し、各フローに対して独自にパーティクルを生成
- 各フローに5-20個のパーティクルを配置（通行量に基づく）
- パーティクルサイズを2-4の範囲に調整
- 速度を0.002-0.005に調整

**今後の課題**: APIのパーティクルデータ構造を修正し、正しいflow_indexマッピングを実装する必要がある

### 人口比例フロー生成の実装
**要望**: 「人口が多いところは多くなり、少ないところは比例して減らしてほしい」
**実装内容**:
1. **mobility_estimator.py の _get_attraction_score メソッドを改良**
   - location辞書全体を受け取るように変更（名前だけでなく人口データも活用）
   - 人口データがある場合は、それを基本スコアとして使用
   - 人口の10%を基本スコアとし、施設タイプに応じて係数を適用:
     - 主要駅（広島駅、福山駅）: 2.0倍
     - その他の駅: 1.5倍
     - 空港: 2.5倍
     - 大学: 1.8倍
     - 市役所・区役所: 0.8倍
     - 観光地（神社、公園）: 1.2倍
     - IC・JCT: 1.3倍

2. **estimate_od_matrix メソッドの修正**
   - _get_attraction_score に location 辞書全体を渡すように変更
   - これにより real_data.py で定義した人口データが活用される

**効果**: 
- 広島市中心部（人口14万人）から多くのフローが発生
- 小規模な町（人口1000-3000人）は少ないフローに
- 県全域で人口に比例した自然な人流表現を実現

### 市区町村内人流の実装
**要望**: 「各市区町村内での人流を表示してほしい」
**実装内容**:
1. **estimate_od_matrix メソッドの改良**
   - get_city_area関数を追加して市区町村を判定
   - 同じ市内の移動を2.5倍に増幅
   - 特に短距離（5km未満）の市内移動はさらに1.5倍
   - 市内移動の最小閾値を300に下げる（通常は500）

2. **広島市の判定を詳細化**
   - 各区（中区、南区、西区、東区、安佐南区、安佐北区、佐伯区、安芸区）を含む
   - 主要施設（広島駅、紙屋町、平和記念公園等）も広島市として判定
   - 広島IC、広島JCT、広島空港、広島大学も含む

3. **表示フロー数の増加**
   - 広島県の表示フロー数を200から300に増加
   - より多くの市内移動を可視化

4. **MDファイルの整理**
   - MD_FILES_MAP.mdを削除（統合後は不要）
   - 現在は5つのMDファイルに整理完了

## MDファイル構成（現在）
- **PROJECT_GUIDE.md**: 作業指示・現状・手順（メインガイド）
- **TECHNICAL_DETAILS.md**: 技術仕様・実装詳細
- **CLAUDE.md**: 作業履歴・引き継ぎ情報（このファイル）
- **README.md**: 外部向け概要
- **DESIGN_REFERENCE.md**: ダミーデータ時のデザイン仕様

## 2025-06-14 実施内容（続き４）

### 距離別フローラインフェード実装
**ユーザー要望**: 「人流データラインのフェードインフェードアウトのタイミングですが、距離ごとにグルーピングしてタイミングを揃えてください、全て一緒のタイミングだとチカチカしてみえるため」

**実装内容**:
1. **CyberFlowLayer.jsの改修**
   - フローを距離別に3グループに分類
     - 短距離（5km未満）: 位相0
     - 中距離（5-20km）: 位相π/3（120度）
     - 長距離（20km以上）: 位相2π/3（240度）
   - 各グループ別にレイヤーを作成
   - フェードタイミングをグループごとに制御

2. **技術的な改善点**
   - 距離計算をベジエ曲線生成前に実施
   - distanceGroups オブジェクトで効率的に管理
   - クリーンアップ処理も新レイヤー構造に対応

**効果**: 全ラインが同時にフェードしていたチカチカが解消され、距離グループごとに滑らかなフェード効果を実現

### MDファイル統合完了
**目的**: 情報の一元化と役割の明確化
**実施内容**:
1. **削除したファイル**
   - TECHNICAL_DETAILS.md → PROJECT_GUIDE.mdに統合
   - DESIGN_REFERENCE.md → PROJECT_GUIDE.mdに統合

2. **最終的なファイル構成（4ファイル）**
   - PROJECT_GUIDE.md: 方針・仕様書（技術・デザイン仕様含む）
   - CLAUDE.md: 作業記録・履歴
   - README.md: 外部向け概要
   - MOBILITY_DATA_ANALYSIS.md: 開発者確認用（一時保持）

**効果**: 方針と作業記録の明確な分離を実現、情報の重複や古い情報の混在を防止

### マップ表現の改善
**ユーザー要望**: 
- 青丸の正体確認と適切な表示方式への変更
- SNSヒートマップのズーム時の色問題解決
- イベント情報のズーム時のサイズ問題解決

**実施内容**:
1. **青丸の調査と修正**
   - 交通データ（Transport）レイヤーが青色で表示されていた
   - デフォルト色 #4A90E2 から #FF6B6B（赤）に変更
   - バックエンドAPIと表示色を統一

2. **SNSヒートマップの改善**
   - ズームレベルに応じた強度調整（0.3～0.8）
   - ズームレベルに応じた半径調整（15～35）
   - 色合いはズームレベルに関係なく一定に保持

3. **イベント情報サイズの改善**
   - ズームアウト時：1/10サイズ（2-10px）
   - ズームイン時：通常サイズ（16-64px）
   - グローレイヤーも同様に調整
   - イベント規模による差をより明確に表現

**効果**: 
- ズームアウト時の見やすさが大幅に改善
- 各レイヤーの色が統一され視認性向上
- イベント規模の差が視覚的に明確になった