# 開発履歴

最終更新: 2025-06-14  
更新者: Claude Code

**重要：このファイルは作業完了時に必ず更新すること**

## 重要：他のMDファイルとの関係
- 作業手順 → PROJECT_GUIDE.md
- 技術詳細 → TECHNICAL_DETAILS.md
- プロジェクト概要 → README.md
- 作業ルール → .claude_instruction

## 作業開始時のチェックリスト
1. [ ] PROJECT_GUIDE.md を読んだ
2. [ ] TECHNICAL_DETAILS.md を読んだ
3. [ ] .claude_instruction を確認した
4. [ ] 現在の問題点を把握した

## プロジェクトコアコンセプト
全国の行政・民間施策効果検証プラットフォーム
- リアルワールドデータ×ソーシャルネットワーキングデータ
- 因果推論AIによる反実仮想分析と未来予測
- 現在は仕様検討のため広島・山口データ可視化中

## 2025-06-11 実施内容（前半）

### 午前の作業
- MDファイル整理（53→3ファイルに削減）
- API実装（real_dataエンドポイント追加）
- 広島・山口データ収集完了
- コアコンセプトの再定義と文書修正

### 午後の作業
- MDファイル更新管理ルールの追加
- .claude_instructionにチェックリスト追加
- realDataLoader.jsを実際のAPI呼び出しに変更
- 各MDファイルに更新追跡情報を追加

### 2025-06-11 午後の作業
- 実データAPIの接続問題解決
- SNSヒートマップカテゴリフィルター問題修正
- 消費データ3D表示エラー修正
- 人流データアニメーション復元
- 3Dレイヤーエラー修正（Point→Polygon変換）

### 2025-06-11 セッション継続後の修正
- 人流データのパーティクルアニメーション修正（ベジエ曲線による北側迂回）
- 宿泊施設の透明度を50%に修正
- ランドマークトグルエラー修正（Point→Polygon変換）

## 2025-06-13 実施内容

### 環境セットアップ
- Docker環境のポート競合解決
  - Redis: 6379→6380
  - PostgreSQL: 5432→5433
  - Frontend: 3000→3001
- 全コンテナの正常起動確認

### エラー修正
- 地域選択時のonPrefectureSelectエラー修正
- CORS設定修正（localhost:3001を許可）
- SNSカテゴリフィルター修正（全OFF時は非表示）
- 人流データフォーマット認識エラー修正

### 人流データの大幅改善
1. **統計的推定モデルの実装**
   - MobilityEstimatorクラスを作成
   - 実際の統計データ使用（広島県人口280万人、通勤者45万人、年間観光客7000万人）
   - 重力モデルによるOD行列推定
   - フロータイプ分類（通勤/観光/一般）

2. **可視化の改善**
   - 山口県を地域選択に追加
   - フローライン透明度を0.15に変更
   - パーティクルのズームレベル対応（1px〜6px）
   - ライン幅を1/3に縮小（0.5px〜2px）
   - パーティクルがベジエ曲線上を正確に移動
   - フロータイプ別色分け統一（通勤:シアン、観光:マゼンタ、一般:イエロー）

3. **データ拡充**
   - 広島県全域40地点に拡大（県北部・東部含む）
   - 地域間移動の可視化実現
   - 3,000パーティクル以上の表示
- SNSヒートマップの色合いをダミーデータ時に統一（青→シアン→白→黄→オレンジ→赤）

### 修正済みの問題（2025-06-11）
1. **人流データのパーティクル** ✓
   - ダミーデータ時と同じベジエ曲線計算を実装
   - 北側迂回表現（Y座標に正のオフセット）を復元

2. **宿泊施設の表現** ✓
   - 透明度を50%に変更完了
   - サイズは0.0005のままで適切（変更不要）

3. **ランドマークトグル** ✓
   - Point→Polygon変換実装で3Dレイヤーエラー解消
   - 別ソースで3Dランドマークを管理

4. **SNSヒートマップ** ✓
   - 色合いをダミーデータ時の配色に統一
   - 青→シアン→白→黄→オレンジ→赤のグラデーション

### 重要な参考情報
- **デザイン仕様**: DESIGN_REFERENCE.mdを参照
- **目標**: ダミーデータ作成時のGitHubに保存された表現を完全にトレース
- **エラー対策**: fill-extrusionレイヤーにはPolygonデータが必須

## 実装した修正内容（2025-06-11 セッション継続後）

### 1. 人流データのパーティクルアニメーション修正
**ファイル**: `src/frontend/src/components/Map/MapWithRealData.jsx`（行936-976）
- ダミーデータ時（commit cb0661d）と同じベジエ曲線計算を実装
- 北側迂回の実装：`y + arcHeight * 0.5` でY座標に正のオフセット
- 主要な変更点：
  ```javascript
  // ベジエ曲線上の位置を計算
  const t = particleProgress;
  const x = start[0] * (1 - t) * (1 - t) + 2 * midpoint[0] * (1 - t) * t + end[0] * t * t;
  const y = start[1] * (1 - t) * (1 - t) + 2 * midpoint[1] * (1 - t) * t + end[1] * t * t;
  
  // 弧の高さ（中央で最大）
  const height = 0.1;
  const arcHeight = Math.sin(t * Math.PI) * height * distance;
  
  // 北向きに迂回（Y座標に正のオフセット）
  feature.geometry.coordinates = [x, y + arcHeight * 0.5];
  ```

### 2. 宿泊施設の透明度修正
**ファイル**: `src/frontend/src/components/Map/MapWithRealData.jsx`（行328）
- `fill-extrusion-opacity: 0.5` に変更（以前は0.8）

### 3. ランドマークトグルエラー修正
**ファイル**: `src/frontend/src/components/Map/MapWithRealData.jsx`（行533-647）
- Point データを Polygon に変換する処理を追加
- 3Dランドマーク用に別ソース `landmarks-3d-source` を作成
- 主要な変更点：
  - ポイントデータと3Dデータを分離
  - 高さ20m以上の建物のみ3D化
  - レイヤーマッピングに `landmarks-3d` を追加（行1055）

### 4. SNSヒートマップの色合い修正
**ファイル**: `src/frontend/src/components/Map/MapWithRealData.jsx`（行934-944）
- ダミーデータ時の配色に統一：
  ```javascript
  0, 'rgba(0,0,255,0)',      // 透明な青
  0.2, 'rgb(0,0,255)',       // 青
  0.4, 'rgb(0,255,255)',     // シアン
  0.5, 'rgb(255,255,255)',   // 白
  0.6, 'rgb(255,255,0)',     // 黄
  0.8, 'rgb(255,170,0)',     // オレンジ
  1, 'rgb(255,0,0)'          // 赤
  ```

### 次回デバッグ時の確認事項
1. 全レイヤーのトグル動作確認（特にランドマーク）
2. 人流パーティクルの北側迂回アニメーション確認
3. 宿泊施設の透明度確認
4. SNSヒートマップの色表現確認
5. パフォーマンスの確認

## 2025-06-14 実施内容

### GTFSエンドポイント修正
- float変換エラーの原因特定と修正
  - BOM付きUTF-8ファイルへの対応（utf-8-sig使用）
  - CSVフォーマットの正確な解析（stop_nameは2列目）
  - 空のstop_codeフィールドの適切な処理
  - 無効な座標データのスキップ処理実装
- 修正後の動作確認完了
- GitHubへのコミット済み

### マップ表現の大幅改善
1. **イベント情報の視覚改善**
   - オーブ風の光る表現に変更（外側ほど透明度が上がる）
   - カテゴリ別色分け（festival: 紫、sports: 青、cultural: 緑）
   - 3層構造（影響範囲、中心の光、白い中心点）

2. **ランドマーク表現の統一**
   - 全て黄色（#FFD700）の円柱に統一
   - ポイントレイヤーも黄色に変更

3. **宿泊施設の改善**
   - 面積を1/3に縮小（0.0005 → 0.0005/3）
   - 高さを収容人数に応じて変更（capacity * 0.3）

4. **PLATEAU建物データの統合**
   - ランドマークトグルに統合（別トグル廃止）
   - 「PLATEAU 3D建物データ」→「建物データ」に名称変更
   - クリック時に枠付きポップアップで建物情報表示

### 今後の優先タスク
1. 6地域データ統合（岡山、福岡、東京、大阪）
2. AI分析機能の拡張（過去分析表示の完成）
3. パフォーマンス最適化

## MDファイル構成（現在）
- **PROJECT_GUIDE.md**: 作業指示・現状・手順（メインガイド）
- **TECHNICAL_DETAILS.md**: 技術仕様・実装詳細
- **CLAUDE.md**: 作業履歴・引き継ぎ情報（このファイル）
- **README.md**: 外部向け概要
- **DESIGN_REFERENCE.md**: ダミーデータ時のデザイン仕様