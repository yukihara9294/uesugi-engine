# Uesugi Engine トラブルシューティング記録

## 2025-01-11 Mapboxエラー解決の試行錯誤

### 問題の概要
- **エラー**: `Cannot read properties of undefined (reading 'sub')`
- **発生場所**: Mapbox内部コード（タイルレンダリング時）
- **症状**: 地図は表示されるがデータレイヤーが一切表示されない

### 試行錯誤の過程

#### 1. 初回アプローチ：エラーハンドリング強化
- null/undefinedチェックの追加
- `coalesce`関数でデフォルト値設定
- **結果**: エラー継続

#### 2. GeoJSONデータ形式の修正
- 広島県データがGeoJSON形式に変換されていないことを発見
- `toGeoJSON`関数を追加してデータ変換
- **結果**: データは読み込まれたがレンダリングエラー継続

#### 3. Mapbox式の安全化
- `safeGet`、`safeMultiply`などのヘルパー関数作成
- 算術演算の前にundefinedチェック
- **結果**: エラー継続

#### 4. 最終解決策：複雑な式の完全削除
- すべての算術演算（`["/", ["get", "value"], 100]`など）を削除
- 3D表示（fill-extrusion）を一時無効化
- 動的な値をすべて固定値に置換
- **結果**: エラー解消、表示成功！

### 根本原因
Mapboxの内部で以下のような式を評価する際：
```javascript
["*", ["get", "height"], 0.3]  // heightがundefinedの場合
["/", ["get", "radius"], 50]   // radiusがundefinedの場合
```
プロパティが存在しない場合、内部で`undefined.sub`のようなアクセスが発生

### 教訓
1. Mapboxの算術演算は、すべてのオペランドが確実に存在することが前提
2. `coalesce`だけでは不十分で、式全体を簡略化する必要がある
3. 開発時は単純な表現から始めて段階的に複雑化すべき

### 今後の改善点
- データ生成時に必須プロパティの検証を強化
- Mapbox式を使用する前にデータ構造のバリデーション
- エラー時のフォールバック表示の実装