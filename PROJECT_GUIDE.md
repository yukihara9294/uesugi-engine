# Uesugi Engine プロジェクトガイド

最終更新: 2025-06-14  
更新者: Claude Code  
更新内容: GTFSエンドポイントエラー修正完了

## 必ず最初に読むこと

1. このファイル（PROJECT_GUIDE.md）で作業概要を把握
2. TECHNICAL_DETAILS.md で技術詳細を確認
3. 不明点は CLAUDE.md の履歴を参照
4. .claude_instruction に従って作業

## 重要：このファイルの更新ルール

**作業終了時に必ず以下を更新：**
- 「現在の状況」セクション
- 「次の作業」セクション
- 冠頭の更新情報（日付・内容）

## MDファイル構成（新規MDファイル作成禁止）
**以下の5つのMDファイルのみ使用：**
- PROJECT_GUIDE.md: 作業指示・現状・手順
- TECHNICAL_DETAILS.md: 技術仕様・実装詳細
- CLAUDE.md: 作業履歴・セッション引き継ぎ
- README.md: 外部向け概要
- DESIGN_REFERENCE.md: ダミーデータ時のデザイン仕様

## プロジェクトのコアコンセプト

全国の行政・民間施策の効果検証プラットフォーム
- リアルワールドデータとソーシャルネットワーキングデータを統合
- 因果推論AIによる過去施策の反実仮想分析
- 未来予測と施策シミュレーション

## 開発フェーズ

### 現在のフェーズ：仕様検討段階
広島県・山口県の取得データを可視化し、仕様を検討中

### 今後の展開
1. 広島・山口データの可視化完成
2. 福岡・東京・大阪データの統合
3. AI因果推論機能の実装
4. 全国展開

## 重要な制約事項

1. 絵文字は使わない
2. AIらしい冗長な文章は書かない
3. 「v2」「simple」などのバージョン違いファイルは作らない
4. 同じ機能の重複実装はしない

## 現在の状況（2025年6月13日）

**※このセクションは毎回更新必須**

### 環境
- Docker環境で動作中（ポート変更済み）
- フロントエンド: http://localhost:3001
- バックエンドAPI: http://localhost:8000/docs
- PostgreSQL: localhost:5433
- Redis: localhost:6380

### データ収集状況
- 広島県: 交通データ（GTFSバス）収集済み
- 山口県: 312ファイル（人口・観光等）収集済み
- 福岡・東京・大阪: 未収集

### 修正済みの問題（2025年6月11日セッション継続後）
- ✓ ランドマークトグルエラー修正（Point→Polygon変換実装）
- ✓ 人流データの北側迂回表現復元（ベジエ曲線による実装）
- ✓ 宿泊施設の透明度修正（50%に変更）
- ✓ SNSヒートマップの色合い修正（青→シアン→白→黄→オレンジ→赤）

### 2025年6月14日の作業状況
- ✓ GTFSエンドポイントのfloat変換エラー修正
  - BOM付きUTF-8対応（utf-8-sig使用）
  - 空のstop_codeフィールド処理追加
  - 無効な座標データのスキップ処理実装
- ✓ マップ表現の大幅改善
  - イベント情報: オーブ風表現、#FF6B6B統一、中心白丸削除
  - ランドマーク: 黄色円柱に統一、高さ制限撤廃
  - 宿泊施設: 面積1/3、収容人数比例の高さ
  - PLATEAU建物: ランドマークに統合、ポップアップ表示
  - 人流データ: パーティクル10倍、速度1/3

### 2025年6月13日の作業状況
- ✓ Docker環境の再起動（ポート競合解決）
- ✓ APIエンドポイントの動作確認
- ✓ GTFSエンドポイントにエラー発見（float変換エラー）→ 6月14日に修正済み
- ✓ SNSヒートマップのカテゴリフィルター修正（全OFF時は非表示）
- ✓ 人流データを大幅増加（広島県：100フロー、3,000パーティクル）
- ✓ 統計的推定モデルによるリアルな人流データ生成
  - 実際の人口・通勤・観光統計に基づく推定
  - 重力モデルによるOD行列推定
  - フロータイプ別色分け（通勤:シアン、観光:マゼンタ、一般:イエロー）
- ✓ 地域選択エラー修正（onPrefectureSelect）
- ✓ CORS設定修正（localhost:3001対応）
- ✓ 人流データフォーマット認識修正
- ✓ 山口県を地域選択に追加
- ✓ 人流可視化の改善
  - フローライン透明度向上（0.3→0.15）
  - パーティクルのズームレベル対応（1px〜6px）
  - 広島県全域の地点追加（40地点、県北部・東部含む）
  - パーティクルがライン上を正確に移動
  - ライン幅を1/3に縮小（0.5px〜2px）
  - フロータイプ別色分け（ライン・パーティクル統一）

## ディレクトリ構造

```
uesugi-engine/
├── PROJECT_GUIDE.md     # このファイル（必読）
├── README.md            # Githubでの表示用
├── src/
│   ├── frontend/        # React
│   └── backend/         # FastAPI
├── scripts/
│   └── dev/             # 古いスクリプト（使用禁止）
└── uesugi-engine-data/  # データ保存場所
```

## 作業優先順位

1. **最優先：ダミーデータ時のデザイン表現を完全に再現**
   - 人流データの北側迂回表現修正
   - ランドマークエラー解消
   - 宿泊施設とSNSヒートマップのデザイン修正
   - 詳細はDESIGN_REFERENCE.md参照

2. **次フェーズ：6地域データ統合**
   - 岡山データの追加
   - 統一フォーマットでの統合

3. **将来：AI分析機能**
   - 因果推論エンジン実装
   - 反実仮想分析
   - 予測機能

## 作業手順

### 1. Docker起動
```bash
cd ~/projects/uesugi-engine
docker-compose up -d
```

### 2. 動作確認
- API確認: curl http://localhost:8000/api/v1/real/accommodation/real/広島県
- ブラウザ確認: http://localhost:3001

### 3. 問題があったら
- docker logs uesugi-engine-backend-1
- docker logs uesugi-engine-frontend-1

## API構成

### 実データエンドポイント
- /api/v1/real/accommodation/real/{都道府県名}
- /api/v1/real/mobility/real/{都道府県名}
- /api/v1/real/events/real/{都道府県名}
- /api/v1/real/transport/gtfs/hiroshima
- /api/v1/real/tourism/facilities/yamaguchi

### フロントエンドサービス
src/frontend/src/services/api.js に realDataService として定義済み。

## 次の作業

**※このセクションは毎回更新必須**

1. **6地域データ統合の準備**
   - 岡山データの追加検討
   - 福岡・東京・大阪の実データ収集
   - 統一フォーマットの設計

2. **AI分析機能の拡張**
   - 因果推論エンジンの実装
   - リアルタイムデータ連携
   - 過去の分析結果表示機能の完成

3. **パフォーマンス最適化**
   - 大量データ処理の効率化
   - レンダリング最適化

## 未完了タスク

- [ ] ダミーデータ時のデザイン完全再現
- [ ] 3Dレイヤーエラーの完全解消
- [ ] 6地域データ統合
- [ ] AI因果推論機能の実装

## 過去の要望事項

- 動くものを早く作る
- 細かい説明は不要
- エラー解消はClaude担当
- ユーザーはUX/仕様検討に集中

## 技術詳細

詳細はTECHNICAL_DETAILS.mdを参照。

### クイックリファレンス
- Mapboxトークン: .envでREACT_APP_MAPBOX_ACCESS_TOKEN設定
- TypeScript: npm install --legacy-peer-deps使用
- API接続: backend:8000→localhost:8000変更済み

## 変更履歴

### 2025-06-11
- MDファイル更新管理ルールを追加
- 実データAPI呼び出し機能を実装
- .claude_instructionにチェックリスト追加
- DESIGN_REFERENCE.mdを作成（ダミーデータ時のデザイン仕様）
- 次回タスクを明確化（デザイン再現にフォーカス）
- **セッション継続後の修正**：
  - 人流パーティクルの北側迂回アニメーション復元
  - 宿泊施設の透明度50%に修正
  - ランドマークトグルエラー修正（Point→Polygon変換）
  - SNSヒートマップ色合い修正（青→シアン→白→黄→オレンジ→赤）