# Uesugi Engine プロジェクトガイド

最終更新: 2025-06-15  
更新者: Claude Code  
更新内容: 施設レイヤー実装、データカウント表示機能追加、API問題対応

## MDファイル構成と役割分担

### ファイル構成（4ファイル体制）
1. **PROJECT_GUIDE.md**（本ファイル）- 方針・仕様書
   - プロジェクトの方針・コンセプト
   - 技術仕様・実装詳細
   - デザイン仕様
   - 現在の課題と次の作業
   - 制約事項・注意点

2. **CLAUDE.md** - 作業記録・履歴
   - 日付ごとの作業実施内容
   - 修正内容の詳細記録
   - エラーと解決方法
   - コミット履歴
   - セッション間の引き継ぎ事項

3. **README.md** - 外部向け概要
   - プロジェクト概要
   - セットアップ手順
   - 基本的な使い方

4. **MOBILITY_DATA_ANALYSIS.md** - 開発者確認用（一時保持）
   - 人流データの詳細分析
   - デバッグ情報

### 更新ルール
- **作業開始時**: PROJECT_GUIDE.mdで現状と方針を確認
- **作業中**: 実施内容をCLAUDE.mdに記録
- **作業終了時**: 
  - PROJECT_GUIDE.mdの「現在の課題と次の作業」を更新
  - CLAUDE.mdに作業内容の詳細を記録
  - 必要に応じて技術仕様・デザイン仕様を更新

## 必ず最初に読むこと

1. このファイル（PROJECT_GUIDE.md）で作業概要と方針を把握
2. 不明点は CLAUDE.md の履歴を参照
3. .claude_instruction に従って作業

## プロジェクトのコアコンセプト

**全国の行政・民間施策効果検証プラットフォーム**
- リアルワールドデータ×ソーシャルネットワーキングデータ
- 因果推論AIによる反実仮想分析と未来予測
- 現在は仕様検討のため広島・山口データ可視化中

## 開発フェーズ

### 現在のフェーズ
**Phase 2: データ可視化と実データ統合**
- ダミーデータから実データへの移行中
- 視覚表現の改善（リアルタイム人流、3D建物など）
- 広島・山口の実データ収集・表示

### 今後の展開
1. **Phase 3**: 6地域（岡山、福岡、大阪、東京）への拡張
2. **Phase 4**: AI因果推論エンジンの実装
3. **Phase 5**: 反実仮想分析と予測機能
4. **Phase 6**: 全国展開とプラットフォーム化

## 技術仕様

### アーキテクチャ
- **フロントエンド**: React + TypeScript + Mapbox GL JS
- **バックエンド**: FastAPI + PostgreSQL + Redis
- **インフラ**: Docker Compose
- **AI/ML**: Python (将来実装)

### 実装済み機能詳細

#### 1. 地図表示の安定化
- マップ初期化ロジック: isMountedフラグとwaitForContainer関数
- 再読み込み時のエラー対策実装
- MapEnhancedFixedコンポーネントで安定化

#### 2. 統計的人流推定モデル
`src/backend/app/services/mobility_estimator.py`で実装
- **基礎統計**: 実際の人口・通勤・観光データ使用
- **重力モデル**: 流動量 = k × (起点魅力度 × 終点魅力度) / 距離^1.5
- **フロー分類**: 通勤(シアン)、観光(マゼンタ)、一般(イエロー)
- **ベジエ曲線**: 自然な移動経路生成
- **距離ベース最適化**:
  - 近距離(1-5km): パーティクル数×1.5、速度×0.15
  - 中距離(5-20km): 標準設定、速度×0.33
  - 遠距離(20km+): パーティクル数×0.5、速度×0.8
- **市内移動の増幅** (2025-06-14追加):
  - 広島市: 3.0倍
  - 福山市・呉市: 2.5倍
  - 東広島市・尾道市等: 2.2倍
  - その他: 2.0倍

#### 3. パフォーマンス最適化 (2025-06-14)
- FPS制限: 20FPS（50ms間隔）
- 表示フロー数: 最大2000本（広島県）
- パーティクル数の階層化:
  - 上位100フロー: 10-30個/フロー
  - 次の400フロー: 5-15個/フロー
  - それ以降: 3-10個/フロー
- 段階的読み込み: 市内データ優先→全県データ

### 重要な技術的注意事項

#### マップとレイヤー表示
- エラーが交互に発生する傾向
- 修正時は両方を同時に検証必須
- `map.isStyleLoaded()`がtrueになるまで待機
- レイヤー初期化は一度だけ実行

#### データ管理
- 初期化時に一度だけ生成
- `dataCache`に保存して再利用
- カテゴリフィルターは既存データのフィルタリング

#### CyberFlowLayer更新処理 (2025-06-14修正)
- `mobilityData`を依存配列に追加
- データ変更時の初期化フラグリセット
- 既存レイヤーの適切なクリーンアップ
- アニメーションの再起動処理

## デザイン仕様

### 基本方針
**ダミーデータ作成時の表現を完全にトレース**

### 1. 人流データ
- **パーティクル表現**：
  - サイズ: ズームレベル対応（8:0.5倍、11:1倍、14:1.5倍）
  - 色: フロータイプ別（通勤:シアン、観光:マゼンタ、一般:イエロー）
  - アニメーション: ベジエ曲線で北側迂回
  - グロー効果: 4層構造（外側ほど薄く大きく）
- **フローライン**：
  - 透明度: フェードイン・アウト（0.0～0.3）
  - 距離グループごとに異なるタイミング（実装予定）

### 2. SNSヒートマップ
- **色合い**: 青→シアン→白→黄→オレンジ→赤
- **透明度**: 0.7
- **ぼかし半径**: 30

### 3. 消費データ
- **3D棒グラフ**：
  - 高さ計算: sqrt(amount) / 50
  - ポリゴンサイズ: 0.00006
  - 透明度: 30%

### 4. 宿泊施設
- **3D表現**：
  - 色: #4CAF50（緑）
  - 透明度: 50%
  - 高さ: capacity * 0.3
  - 面積: 0.0005/3

### 5. ランドマーク
- **3D表現**：
  - 色: #FFD700（黄色）統一
  - 円柱形状
  - 全ランドマークを3D表示

### 6. イベント情報
- **表現方法**：
  - オーブ風の光る表現（2層構造）
  - 色: #FF6B6B
  - サイズ: expected_visitorsに基づく

## 現在の問題点と対応状況

### 解決済みの問題
1. **人流データのAPI接続** - NumPy依存を削除して解決
2. **宿泊施設・消費データの表示** - APIパス修正で34件/6件表示成功
3. **イベント情報の表示** - EventServiceをシンプル化して解決
4. **公共交通オーブ効果** - stroke削除とopacity追加で解決

### 現在の問題（2025-06-15）
1. **施設APIの504タイムアウト**
   - 原因: CSVファイル処理が重い（638ファイル）
   - 暫定対応: テストデータへの自動フォールバック
   - 恒久対応: バッチ処理による事前集計が必要

2. **一部APIのタイムアウト（90秒）**
   - Tourism data、Event data、Transport data等
   - 原因調査中

### 技術的制約による保留事項
1. **SNSヒートマップのズーム依存**
   - Mapbox内部仕様により固定値でもスケーリングされる
   - ユーザー判断により現状維持

2. **イベントマーカーのズーム依存**
   - 同上の理由により「一旦諦める」との判断

## 現在の課題と次の作業

### 完了したタスク（2025-06-15）
- [x] 山口県施設データ可視化レイヤー実装
  - 医療施設・AED（MedicalLayer.js）
  - 教育施設（EducationLayer.js）
  - 避難所・防災（DisasterLayer.js）
  - 638ファイルのオープンデータから抽出
- [x] バックエンドAPI拡充
  - /api/v1/facilities/medical/{prefecture}
  - /api/v1/facilities/education/{prefecture}
  - /api/v1/facilities/disaster/{prefecture}
  - エンコーディング処理の改善（shift-jis、cp932対応）
- [x] API 504エラー対策
  - MAX_FEATURES=100に削減
  - テストデータフォールバック実装
  - 各レイヤーで5-6倍サイズのテストマーカー表示
- [x] 公共交通オーブ効果の改善
  - 白縁削除（stroke-width: 0）
  - 50%透明度追加（opacity: 0.5）
  - 3層構造でオーブ効果を実現
- [x] データカウント表示機能実装
  - 各レイヤーのトグル横にデータ数を表示
  - リアルタイムでカウント更新
  - 全レイヤー対応（mobility、transport、facilities等）

### 完了したタスク（2025-06-14）
- [x] パーティクルサイズのズーム対応
- [x] 広島県全域への拡張（120地点以上）
- [x] 人口比例フロー生成
- [x] 市区町村内人流の表示
- [x] 閾値調整による可視化向上
- [x] FPS制限とパフォーマンス最適化
- [x] CyberFlowLayerのデータ更新問題修正
- [x] フローラインの距離別フェード実装（チカチカ解消）
- [x] MDファイル統合（6→4ファイルに整理）
- [x] SNSヒートマップのズーム非依存実装（heatmapタイプ使用）
- [x] コードのリファクタリング（未使用コード削除、本番環境対応）
- [x] 公共交通機関レイヤーの実装（TransportLayer）
  - GTFSデータAPI作成（/api/v1/transport/gtfs）
  - 路線・停留所の可視化実装
  - 左サイドバーにトグル追加
- [x] 3Dレイヤーエラー解消
  - 未使用PlateauLayer.js削除（React Leaflet互換性問題）
  - イベントリスナーの重複登録防止
  - エラーハンドリング強化

### 高優先度タスク
1. **バックエンド施設APIのパフォーマンス改善**
   - CSVファイル処理の最適化
   - キャッシュ機構の実装
   - 事前集計データの準備

### 中優先度タスク
3. **岡山データ統合準備**
4. **6地域統一フォーマット設計**

### 保留中のタスク（技術的制約により）
- **SNSヒートマップのズーム非依存実装**
  - 現状：6/9のダミーデータ実装と同じheatmapタイプ使用
  - 問題：Mapbox内部でズームスケーリングが適用される
  - 詳細：CLAUDE.mdの「SNSヒートマップとイベント情報のズーム依存問題の詳細記録」参照
  
- **イベントマーカーのズーム非依存実装**
  - ユーザー指示により一旦諦める
  - 固定値を設定してもMapboxが内部的にスケーリング
  - 詳細：CLAUDE.mdの「SNSヒートマップとイベント情報のズーム依存問題の詳細記録」参照

### 将来タスク
5. **AI因果推論エンジン実装**
6. **反実仮想分析機能**
7. **予測シミュレーション機能**

## 重要な制約事項

### ポート設定
- Frontend: 3000
- Backend: 8000
- PostgreSQL: 5433
- Redis: 6380

### 環境依存
- WSL2環境での動作確認済み
- Dockerコンテナ名に`-1`サフィックス付き

### API制限
- Mapbox: 月間リクエスト制限あり
- OpenWeatherMap: 無料枠制限あり

### データ制限
- 人流データ表示: 最大2000フロー/県
- パーティクル数: 動的調整（パフォーマンス考慮）

## データ収集実績

### 広島県
- 広島電鉄GTFSデータ: 169路線、2,416停留所
- 実在ランドマーク: 120箇所以上
- 実在ホテル: 90-175軒
- 人流フロー: 7,068本生成、2,000本表示

### 山口県
- オープンデータ: 93件（312ファイル）
- 人口、観光、イベント、交通データ

### API実装
- ODPT APIキー設定完了（関東地域のみ）
- e-Stat APIキー設定完了
- real_dataエンドポイント実装済み